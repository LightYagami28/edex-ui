name: Daily Vulnerability Scan

on:
  schedule:
    # Run daily at 00:00 UTC for 24/7 coverage
    - cron: '0 0 * * *'
  # Allow manual trigger
  workflow_dispatch:
  # Run on push to master to catch new vulnerabilities immediately
  push:
    branches: [ master ]
  # Run on PRs to prevent introducing vulnerabilities
  pull_request:
    branches: [ master ]

jobs:
  audit-root-dependencies:
    name: Audit Root Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit-root
        run: |
          echo "Running npm audit on root dependencies..."
          npm audit --json > audit-root.json || true
          npm audit || echo "::warning::Vulnerabilities found in root dependencies"
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: audit-root-results
          path: audit-root.json
          retention-days: 30

  audit-src-dependencies:
    name: Audit Source Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Install root dependencies
        run: npm ci

      - name: Install src dependencies
        run: cd src && npm ci

      - name: Run npm audit on src
        id: audit-src
        run: |
          echo "Running npm audit on src dependencies..."
          cd src
          npm audit --json > ../audit-src.json || true
          npm audit || echo "::warning::Vulnerabilities found in src dependencies"
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: audit-src-results
          path: audit-src.json
          retention-days: 30

  check-for-updates:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check outdated root dependencies
        run: |
          echo "Checking outdated root dependencies..."
          npm outdated || true

      - name: Check outdated src dependencies
        run: |
          echo "Checking outdated src dependencies..."
          cd src
          npm ci
          npm outdated || true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261
        continue-on-error: true  # May fail if Dependency graph is not enabled in repo settings
        with:
          fail-on-severity: moderate
          allow-licenses: GPL-3.0, MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD, CC0-1.0

  create-issue-on-vulnerability:
    name: Create Issue on Critical Vulnerabilities
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    needs: [audit-root-dependencies, audit-src-dependencies]
    if: always() && github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Download root audit results
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: audit-root-results
        continue-on-error: true

      - name: Download src audit results
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: audit-src-results
        continue-on-error: true

      - name: Check for critical vulnerabilities
        id: check-critical
        run: |
          CRITICAL_FOUND=false
          
          # Check root dependencies
          if [ -f audit-root.json ]; then
            CRITICAL_COUNT=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "critical")] | length' audit-root.json || echo "0")
            HIGH_COUNT=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "high")] | length' audit-root.json || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              CRITICAL_FOUND=true
              echo "Found $CRITICAL_COUNT critical and $HIGH_COUNT high severity vulnerabilities in root dependencies"
            fi
          fi
          
          # Check src dependencies
          if [ -f audit-src.json ]; then
            CRITICAL_COUNT=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "critical")] | length' audit-src.json || echo "0")
            HIGH_COUNT=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "high")] | length' audit-src.json || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              CRITICAL_FOUND=true
              echo "Found $CRITICAL_COUNT critical and $HIGH_COUNT high severity vulnerabilities in src dependencies"
            fi
          fi
          
          echo "critical_found=$CRITICAL_FOUND" >> $GITHUB_OUTPUT

      - name: Create or update issue
        if: steps.check-critical.outputs.critical_found == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const fs = require('fs');
            
            let body = '## ðŸš¨ Critical/High Severity Vulnerabilities Detected\n\n';
            body += 'The daily vulnerability scan has detected critical or high severity vulnerabilities.\n\n';
            body += '### Action Required\n';
            body += '1. Review the audit reports attached to the workflow run\n';
            body += '2. Update affected dependencies\n';
            body += '3. Run `npm audit fix` where possible\n';
            body += '4. For manual fixes, check the specific package versions\n\n';
            body += '### Audit Reports\n';
            body += `[View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
            
            // Add details from audit files if available
            try {
              if (fs.existsSync('audit-root.json')) {
                const auditRoot = JSON.parse(fs.readFileSync('audit-root.json', 'utf8'));
                body += '#### Root Dependencies\n';
                body += `- Total vulnerabilities: ${Object.keys(auditRoot.vulnerabilities || {}).length}\n`;
              }
            } catch (e) {
              console.log('Could not parse audit-root.json');
            }
            
            try {
              if (fs.existsSync('audit-src.json')) {
                const auditSrc = JSON.parse(fs.readFileSync('audit-src.json', 'utf8'));
                body += '#### Src Dependencies\n';
                body += `- Total vulnerabilities: ${Object.keys(auditSrc.vulnerabilities || {}).length}\n`;
              }
            } catch (e) {
              console.log('Could not parse audit-src.json');
            }
            
            body += '\n---\n';
            body += `Last scan: ${new Date().toISOString()}\n`;
            
            // Search for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,vulnerability-scan',
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Critical/High Severity Vulnerabilities')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Critical/High Severity Vulnerabilities Detected',
                body: body,
                labels: ['security', 'vulnerability-scan', 'critical']
              });
            }
